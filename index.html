<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Бронь переговорных — Прайм Самолет Плюс</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body,#root{height:100%}
    .logo-fallback{font-weight:800;letter-spacing:.02em}
    img.hide-on-error{display:block}
    img.hide-on-error[aria-hidden="true"]{display:none}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    // Telegram init
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    // Helpers
    const uid = () => Math.random().toString(36).slice(2,9)
    const toISODate = (d) => new Date(d).toISOString().slice(0,10)

    // Local storage wrapper
    const LS_KEY = 'roomie_ru_v1';
    const loadState = () => {
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; } catch { return null }
    }
    const saveState = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s))

    // Defaults
    const defaultRooms = [
      {id:'r1', name:'Б1. Переговорная', capacity:6, equipment:['TV','HDMI']},
      {id:'r2', name:'Б2. Переговорная', capacity:10, equipment:['TV','HDMI','Камера']},
      {id:'r3', name:'Zoom-комната', capacity:2, equipment:['Наушники']},
    ]

    function App(){
      const [state, setState] = React.useState(() => loadState() || {
        role:'user', // 'admin' | 'user'
        pins:{ admin:'1357', user:'0000' },
        rooms: defaultRooms,
        bookings: [], // {id, roomId, title, date, start, end, repeat, count, who}
      })

      React.useEffect(()=> saveState(state), [state])

      const [showAuth, setShowAuth] = React.useState(false)
      const [pin, setPin] = React.useState('')

      const isAdmin = state.role === 'admin'

      // Add booking
      function addBooking(b){
        setState(prev=> ({...prev, bookings:[...prev.bookings, {...b, id:uid(), who: tg?.initDataUnsafe?.user?.username||'you'}]}))
      }

      function removeBooking(id){ setState(p=> ({...p, bookings:p.bookings.filter(x=>x.id!==id)})) }

      function sendToBot(){
        try{
          const payload = { type:'sync_calendar', bookings: state.bookings }
          if (tg){ tg.sendData(JSON.stringify(payload)); tg.showPopup({title:'Отправлено',message:'Бронирования отправлены в бота для синхронизации с календарём.',buttons:[{type:'ok'}]}) }
        }catch(e){ alert('Не удалось отправить: '+e.message) }
      }

      return (
        <div className="min-h-full max-w-3xl mx-auto p-4 sm:p-6">
          <Header brand={{text:'прайм самолёт плюс'}} onAuth={()=>setShowAuth(true)} role={state.role} isAdmin={isAdmin} />

          <Card className="mt-4">
            <h2 className="text-lg font-semibold">Новая бронь</h2>
            <NewBooking rooms={state.rooms} onCreate={(b)=>{
              const list = expandRecurring(b)
              list.forEach(addBooking)
              if (tg){ tg.HapticFeedback?.impactOccurred('medium'); }
            }} />
          </Card>

          <Card className="mt-4">
            <div className="flex items-start justify-between gap-2">
              <h2 className="text-lg font-semibold">Мои брони</h2>
              <div className="flex gap-2">
                <Button onClick={sendToBot}>Синхронизировать с календарём</Button>
                <a className="inline-flex items-center px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50" download="bookings.csv" href={csvHref(state.bookings)}>Экспорт CSV</a>
              </div>
            </div>
            <BookingList rooms={state.rooms} items={state.bookings} onDelete={removeBooking} />
          </Card>

          {showAuth && (
            <AuthDialog pins={state.pins} onClose={()=>setShowAuth(false)} onSubmit={(p)=>{
              if (p===state.pins.admin){ setState(s=>({...s, role:'admin'})); setShowAuth(false) }
              else if (p===state.pins.user){ setState(s=>({...s, role:'user'})); setShowAuth(false) }
              else { alert('Неверный PIN') }
            }} />
          )}
        </div>
      )
    }

    function Header({brand, onAuth, role, isAdmin}){
      const [imgHidden, setImgHidden] = React.useState(false)
      return (
        <header className="flex items-center justify-between gap-3">
          <div className="flex items-center gap-3">
            <img src="logo.png" alt="Логотип" className="h-10 w-10 rounded-md hide-on-error" aria-hidden={imgHidden}
                 onError={()=>setImgHidden(true)} />
            {!imgHidden && <span className="sr-only">Прайм Самолет Плюс</span>}
            {imgHidden && (
              <div className="logo-fallback text-xl">прайм самолёт <span className="px-2 py-0.5 rounded bg-black text-white ml-1">плюс</span></div>
            )}
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-slate-500">Роль: {role==='admin' ? 'Админ' : 'Пользователь'}</span>
            <Button onClick={onAuth}>Войти по PIN</Button>
          </div>
        </header>
      )
    }

    function Card({children, className=''}){
      return <section className={"p-4 sm:p-5 bg-white rounded-2xl shadow border "+className}>{children}</section>
    }
    function Button({children, className='', ...props}){ return <button className={"inline-flex items-center justify-center px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-black active:opacity-90 "+className} {...props}>{children}</button> }

    function AuthDialog({pins, onClose, onSubmit}){
      const [v,setV] = React.useState('')
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/40 p-4" role="dialog">
          <div className="w-full max-w-sm bg-white rounded-2xl p-5 shadow-xl">
            <h3 className="text-lg font-semibold mb-3">Авторизация по PIN</h3>
            <input className="w-full border rounded-xl px-3 py-2 mb-3" value={v} inputMode="numeric" maxLength={8} placeholder="Введите PIN"
                   onChange={(e)=>setV(e.target.value)} />
            <div className="flex gap-2 justify-end">
              <button className="px-3 py-2 text-sm" onClick={onClose}>Отмена</button>
              <Button onClick={()=>onSubmit(v)}>Войти</Button>
            </div>
            <p className="mt-3 text-xs text-slate-500">Админ: {pins.admin} • Пользователь: {pins.user}</p>
          </div>
        </div>
      )
    }

    function NewBooking({rooms, onCreate}){
      const today = toISODate(new Date())
      const [form,setForm] = React.useState({
        title:'Бронь переговорной',
        roomId: rooms[0]?.id,
        date: today,
        start: '10:00',
        end: '11:00',
        repeat: 'none', // none | daily | weekly
        count: 1,
      })

      React.useEffect(()=>{
        if (tg){
          tg.MainButton.setParams({text:'Создать бронь'})
          tg.MainButton.onClick(()=> handleCreate())
          tg.MainButton.show()
          return ()=> tg.MainButton.hide()
        }
      }, [form])

      function handleCreate(){
        if (!form.roomId) return alert('Выберите переговорную')
        if (form.start >= form.end) return alert('Время окончания должно быть позже начала')
        onCreate({...form})
      }

      return (
        <div className="grid sm:grid-cols-2 gap-3">
          <div>
            <label className="block text-xs text-slate-500 mb-1">Переговорная</label>
            <select className="w-full border rounded-xl px-3 py-2" value={form.roomId} onChange={e=>setForm(f=>({...f, roomId:e.target.value}))}>
              {rooms.map(r=> <option value={r.id} key={r.id}>{r.name} · {r.capacity} мест</option>)}
            </select>
          </div>
          <div>
            <label className="block text-xs text-slate-500 mb-1">Название</label>
            <input className="w-full border rounded-xl px-3 py-2" value={form.title} onChange={e=>setForm(f=>({...f, title:e.target.value}))} />
          </div>
          <div>
            <label className="block text-xs text-slate-500 mb-1">Дата</label>
            <input type="date" className="w-full border rounded-xl px-3 py-2" value={form.date} onChange={e=>setForm(f=>({...f, date:e.target.value}))} />
          </div>
          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="block text-xs text-slate-500 mb-1">Начало</label>
              <input type="time" className="w-full border rounded-xl px-3 py-2" value={form.start} onChange={e=>setForm(f=>({...f, start:e.target.value}))} />
            </div>
            <div>
              <label className="block text-xs text-slate-500 mb-1">Окончание</label>
              <input type="time" className="w-full border rounded-xl px-3 py-2" value={form.end} onChange={e=>setForm(f=>({...f, end:e.target.value}))} />
            </div>
          </div>
          <div>
            <label className="block text-xs text-slate-500 mb-1">Повтор</label>
            <select className="w-full border rounded-xl px-3 py-2" value={form.repeat} onChange={e=>setForm(f=>({...f, repeat:e.target.value}))}>
              <option value="none">Без повтора</option>
              <option value="daily">Каждый день</option>
              <option value="weekly">Каждую неделю</option>
            </select>
          </div>
          <div>
            <label className="block text-xs text-slate-500 mb-1">Количество повторов</label>
            <input type="number" min={1} max={60} className="w-full border rounded-xl px-3 py-2" value={form.count} onChange={e=>setForm(f=>({...f, count:Number(e.target.value||1)}))} />
          </div>
          <div className="sm:col-span-2 flex gap-2">
            <Button onClick={handleCreate}>Создать бронь</Button>
            <a className="inline-flex items-center px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50" download="booking.ics" href={icsHref(form)}>Скачать .ics</a>
          </div>
        </div>
      )
    }

    function expandRecurring(b){
      const list = []
      const base = new Date(b.date+'T'+b.start)
      for (let i=0;i<(b.count||1);i++){
        const d = new Date(base)
        if (b.repeat==='daily') d.setDate(d.getDate()+i)
        else if (b.repeat==='weekly') d.setDate(d.getDate()+7*i)
        list.push({...b, date: toISODate(d)})
      }
      return list
    }

    function BookingList({rooms, items, onDelete}){
      if (!items.length) return <p className="text-sm text-slate-500">Пока нет броней.</p>
      const byDate = [...items].sort((a,b)=> (a.date+a.start).localeCompare(b.date+b.start))
      const roomName = (id)=> rooms.find(r=>r.id===id)?.name||'—'
      return (
        <ul className="divide-y">
          {byDate.map(b=> (
            <li key={b.id} className="py-3 flex items-center justify-between gap-3">
              <div>
                <div className="font-medium">{b.title}</div>
                <div className="text-xs text-slate-500">{roomName(b.roomId)} · {fmtDate(b.date)} · {b.start}–{b.end}</div>
              </div>
              <div className="flex gap-2">
                <a className="px-3 py-2 rounded-xl border text-sm" download={`booking-${b.id}.ics`} href={icsHref(b)}>ICS</a>
                <button className="px-3 py-2 rounded-xl border text-sm" onClick={()=>onDelete(b.id)}>Удалить</button>
              </div>
            </li>
          ))}
        </ul>
      )
    }

    function fmtDate(d){
      const dd = new Date(d+'T00:00:00')
      return dd.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' })
    }

    // CSV helper
    function csvHref(list){
      if (!list?.length){ return 'data:text/plain;charset=utf-8,'+encodeURIComponent('') }
      const header = ['title','room','date','start','end']
      const rows = list.map(b=> [b.title, b.roomId, b.date, b.start, b.end])
      const all = [header, ...rows].map(r=> r.map(v=> '"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n')
      return 'data:text/csv;charset=utf-8,'+encodeURIComponent(all)
    }

    // ICS helper (single event)
    function icsHref(b){
      const dt = (d,t)=> d.replaceAll('-','')+'T'+t.replace(':','')+'00'
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Roomie RU//EN','CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        'UID:'+uid()+'@roomie',
        'DTSTAMP:'+dt(toISODate(new Date()), new Date().toTimeString().slice(0,5)),
        'DTSTART:'+dt(b.date,b.start),
        'DTEND:'+dt(b.date,b.end),
        'SUMMARY:'+b.title,
        'DESCRIPTION:Переговорная',
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n')
      return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics)
    }

    const root = ReactDOM.createRoot(document.getElementById('root'))
    root.render(<App />)
  </script>
</body>
</html>
