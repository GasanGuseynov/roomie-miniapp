<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roomie+ — Прайм Самолет Плюс</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body,#root{height:100%}
    .brand{font-weight:800;letter-spacing:.02em}
    .noselect{-webkit-user-select:none;-ms-user-select:none;user-select:none}
  </style>
</head>
<body class="bg-black text-white">
  <div id="root"></div>

  <script type="text/babel">
    // ——— helpers
    const tg = window.Telegram?.WebApp; if (tg){ tg.ready(); tg.expand(); }
    const uid = () => Math.random().toString(36).slice(2,9)
    const toISODate = (d) => new Date(d).toISOString().slice(0,10)
    const hm2m = (hm)=>{ const [h,m] = (hm||'00:00').split(':').map(Number); return h*60+m }
    const m2hm = (m)=> `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v))

    const LS_KEY = 'roomie_pro_v1'
    const loadState = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY))||null }catch{ return null } }
    const saveState = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s))

    const defaultRooms = [
      {id:'r1', name:'Белая 1', capacity:6, equipment:['TV','HDMI']},
      {id:'r2', name:'Белая 2', capacity:10, equipment:['TV','HDMI','Камера']},
      {id:'r3', name:'Zoom‑капсула', capacity:2, equipment:['Гарнитура']},
    ]

    function App(){
      const [state, setState] = React.useState(()=> loadState() || {
        role:'user', pins:{admin:'0404', user:'0000'},
        rooms: defaultRooms,
        bookings: [], // {id, roomId, title, date, start, end, repeat, count, who, status}
        settings:{ workStart:'08:00', workEnd:'20:00', step:30, bufferBefore:0, bufferAfter:0, requireCheckin:true, checkinWindow:15 }
      })
      React.useEffect(()=> saveState(state), [state])

      const [showAuth,setShowAuth] = React.useState(false)
      const [showAdmin,setShowAdmin] = React.useState(false)
      const [editing,setEditing] = React.useState(null)

      const isAdmin = state.role==='admin'
      const setSettings = (p)=> setState(s=>({...s, settings:{...s.settings, ...p}}))
      const setRooms = (rooms)=> setState(s=>({...s, rooms}))

      // ——— Anti-overlap + buffers
      function conflicts(a,b){
        if (a.roomId!==b.roomId || a.date!==b.date) return false
        const bufB = Number(state.settings.bufferBefore||0), bufA = Number(state.settings.bufferAfter||0)
        const aStart = hm2m(a.start)-bufB, aEnd = hm2m(a.end)+bufA
        const bStart = hm2m(b.start)-bufB, bEnd = hm2m(b.end)+bufA
        return aStart < bEnd && bStart < aEnd
      }
      function addBooking(b){
        const list = expandRecurring(b)
        for (const x of list){
          const hit = state.bookings.find(ex=> conflicts(ex, x))
          if (hit) { toast(`Пересечение с «${hit.title}» (${hit.start}–${hit.end})`); return }
        }
        const who = tg?.initDataUnsafe?.user?.username || 'you'
        const withStatus = list.map(x=> ({...x, id:uid(), who, status:'scheduled'}))
        setState(prev=> ({...prev, bookings:[...prev.bookings, ...withStatus]}))
        tg?.HapticFeedback?.impactOccurred('medium')
      }
      function removeBooking(id){ setState(p=> ({...p, bookings:p.bookings.filter(x=>x.id!==id)})) }
      function updateBooking(patch){
        if (patch.start||patch.end||patch.date||patch.roomId){
          const curr = state.bookings.find(b=> b.id===patch.id)
          if (!curr) return
          const next = {...curr, ...patch}
          const others = state.bookings.filter(b=> b.id!==patch.id)
          const hit = others.find(ex=> conflicts(ex, next))
          if (hit) { toast(`Пересечение с «${hit.title}» (${hit.start}–${hit.end})`); return }
        }
        setState(p=> ({...p, bookings:p.bookings.map(b=> b.id===patch.id? {...b, ...patch}: b)}))
      }

      // ——— check-in engine
      function canCheckIn(b){
        if (!state.settings.requireCheckin) return false
        const now = new Date()
        const bStart = new Date(`${b.date}T${b.start}:00`)
        const bEnd = new Date(`${b.date}T${b.end}:00`)
        const winM = Number(state.settings.checkinWindow||15)
        const openFrom = new Date(bStart.getTime() - winM*60000)
        return now>=openFrom && now<=bEnd && b.status!=='checked-in'
      }
      function refreshStatuses(){
        const now = new Date()
        setState(p=> ({...p, bookings: p.bookings.map(b=>{
          if (!state.settings.requireCheckin) return b
          if (b.status==='checked-in') return b
          const bStart = new Date(`${b.date}T${b.start}:00`)
          const bEnd = new Date(`${b.date}T${b.end}:00`)
          const winM = Number(state.settings.checkinWindow||15)
          const openFrom = new Date(bStart.getTime() - winM*60000)
          if (now>bEnd && b.status!=='checked-in') return {...b, status:'no-show'}
          if (now>=openFrom && now<=bEnd && b.status==='scheduled') return {...b, status:'awaiting'}
          return b
        })}))
      }
      React.useEffect(()=>{ refreshStatuses(); const t=setInterval(refreshStatuses,30000); return ()=>clearInterval(t) },[state.settings.requireCheckin,state.settings.checkinWindow])
      const checkIn = (id)=> updateBooking({id, status:'checked-in'})

      // ——— sync to bot
      function sendToBot(){
        try{
          const payload = { type:'sync_calendar', bookings: state.bookings }
          if (tg){ tg.sendData(JSON.stringify(payload)); toast('Отправлено в бота для синхронизации') }
        }catch(e){ toast('Не удалось отправить: '+e.message) }
      }

      return (
        <div className="min-h-full max-w-5xl mx-auto p-4 sm:p-6">
          <Header onAuth={()=>setShowAuth(true)} role={state.role} />

          <div className="grid lg:grid-cols-2 gap-4 mt-4">
            <Card>
              <h2 className="text-lg font-semibold">Новая бронь</h2>
              <NewBooking rooms={state.rooms} step={state.settings.step} onCreate={addBooking} />
            </Card>
            <Card>
              <div className="flex items-start justify-between gap-2">
                <h2 className="text-lg font-semibold">Мои брони</h2>
                <div className="flex gap-2">
                  <Button onClick={sendToBot}>Синхронизировать</Button>
                  <a className="inline-flex items-center px-3 py-2 rounded-xl border border-white/15 bg-white/5 text-sm hover:bg-white/10" download="bookings.csv" href={csvHref(state.bookings)}>CSV</a>
                </div>
              </div>
              <BookingList isAdmin={isAdmin} rooms={state.rooms} items={state.bookings}
                onDelete={removeBooking} onEdit={setEditing} onCheckIn={checkIn} canCheckIn={canCheckIn} />
            </Card>
          </div>

          <Card className="mt-4">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold">Календарь</h2>
              {isAdmin && <Button onClick={()=>setShowAdmin(true)}>Админ‑панель</Button>}
            </div>
            <CalendarView rooms={state.rooms} bookings={state.bookings} settings={state.settings}
              onEdit={setEditing} onDragSave={updateBooking} />
          </Card>

          {showAuth && (
            <AuthDialog pins={state.pins} onClose={()=>setShowAuth(false)} onSubmit={(p)=>{
              if (p===state.pins.admin){ setState(s=>({...s, role:'admin'})); setShowAuth(false) }
              else if (p===state.pins.user){ setState(s=>({...s, role:'user'})); setShowAuth(false) }
              else toast('Неверный PIN')
            }} />
          )}

          {showAdmin && (
            <AdminPanel onClose={()=>setShowAdmin(false)} pins={state.pins} settings={state.settings} rooms={state.rooms}
              onPins={(pins)=> setState(s=>({...s, pins}))}
              onSettings={setSettings} onRooms={setRooms}
              onImport={(json)=> setState(s=>({...s, ...json}))} />
          )}

          {editing && (
            <EditDialog booking={editing} rooms={state.rooms} step={state.settings.step}
              onClose={()=>setEditing(null)}
              onSave={(patch)=>{ updateBooking(patch); setEditing(null) }}
              onDelete={()=>{ removeBooking(editing.id); setEditing(null) }} />
          )}

          <ToastBar />
        </div>
      )
    }

    // ——— UI
    function Header({onAuth, role}){
      return (
        <header className="flex items-center justify-between gap-3">
          <div className="flex items-center gap-3">
            <img src="logo.png" alt="Прайм Самолет Плюс" className="h-10 w-10 rounded" onError={(e)=>e.currentTarget.style.display='none'} />
            <div className="brand text-xl">прайм самолёт <span className="px-2 py-0.5 rounded bg-white text-black ml-1">плюс</span></div>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-white/60">Роль: {role==='admin' ? 'Админ' : 'Пользователь'}</span>
            <Button onClick={onAuth}>{role==='admin'?'Сменить роль':'Войти по PIN'}</Button>
          </div>
        </header>
      )
    }

    function Card({children, className=''}){ return <section className={"p-4 sm:p-5 bg-white/5 border border-white/10 rounded-2xl shadow "+className}>{children}</section> }
    function Button({children, className='', ...props}){ return <button className={"inline-flex items-center justify-center px-3 py-2 rounded-xl bg-white text-black text-sm hover:bg-white/90 active:opacity-90 "+className} {...props}>{children}</button> }

    function AuthDialog({pins, onClose, onSubmit}){
      const [v,setV] = React.useState('')
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 p-4" role="dialog">
          <div className="w-full max-w-sm bg-white/10 border border-white/15 backdrop-blur rounded-2xl p-5 shadow-xl">
            <h3 className="text-lg font-semibold mb-3">Авторизация по PIN</h3>
            <input className="w-full border border-white/15 bg-white/5 rounded-xl px-3 py-2 mb-3" value={v} inputMode="numeric" maxLength={8} placeholder=\"Введите PIN\"
                   onChange={(e)=>setV(e.target.value)} />
            <div className="flex gap-2 justify-end">
              <button className="px-3 py-2 text-sm text-white/80" onClick={onClose}>Отмена</button>
              <Button onClick={()=>onSubmit(v)}>Войти</Button>
            </div>
          </div>
        </div>
      )
    }

    function NewBooking({rooms, onCreate, step=30}){
      const today = toISODate(new Date())
      const [form,setForm] = React.useState({ title:'Бронь переговорной', roomId: rooms[0]?.id, date: today, start:'10:00', end:'11:00', duration:60, repeat:'none', count:1 })

      // авто‑установка окончания от длительности
      React.useEffect(()=>{
        const endMin = hm2m(form.start) + Number(form.duration||60)
        setForm(f=>({...f, end:m2hm(endMin)}))
        // eslint-disable-next-line
      }, [form.start, form.duration])

      React.useEffect(()=>{ if (tg){ tg.MainButton.setParams({text:'Создать бронь'}); tg.MainButton.onClick(()=> handleCreate()); tg.MainButton.show(); return ()=> tg.MainButton.hide() } }, [form])
      function handleCreate(){ if(!form.roomId) return toast('Выберите переговорную'); if(form.start>=form.end) return toast('Окончание должно быть позже начала'); onCreate({...form}) }
      return (
        <div className=\"grid sm:grid-cols-2 gap-3\">
          <Select label=\"Переговорная\" value={form.roomId} onChange={(v)=>setForm(f=>({...f, roomId:v}))}>
            {rooms.map(r=> <option value={r.id} key={r.id}>{r.name} · {r.capacity}</option>)}
          </Select>
          <Input label=\"Название\" value={form.title} onChange={(v)=>setForm(f=>({...f, title:v}))} />
          <Input type=\"date\" label=\"Дата\" value={form.date} onChange={(v)=>setForm(f=>({...f, date:v}))} />
          <div className=\"grid grid-cols-2 gap-2\">
            <Input type=\"time\" step={step*60} label=\"Начало\" value={form.start} onChange={(v)=>setForm(f=>({...f, start:v}))} />
            <Select label=\"Длительность\" value={String(form.duration)} onChange={(v)=>setForm(f=>({...f, duration:Number(v)}))}>
              <option value=\"30\">30 мин</option>
              <option value=\"60\">1 час</option>
              <option value=\"90\">1,5 часа</option>
              <option value=\"120\">2 часа</option>
            </Select>
          </div>
          <Input type=\"time\" step={step*60} label=\"Окончание\" value={form.end} onChange={(v)=>setForm(f=>({...f, end:v}))} />
          <Select label=\"Повтор\" value={form.repeat} onChange={(v)=>setForm(f=>({...f, repeat:v}))}>
            <option value=\"none\">Без повтора</option>
            <option value=\"daily\">Каждый день</option>
            <option value=\"weekly\">Каждую неделю</option>
          </Select>
          <Input type=\"number\" min={1} max={60} label=\"Количество повторов\" value={form.count} onChange={(v)=>setForm(f=>({...f, count:Number(v||1)}))} />
          <div className=\"sm:col-span-2 flex gap-2\">
            <Button onClick={handleCreate}>Создать бронь</Button>
            <a className=\"inline-flex items-center px-3 py-2 rounded-xl border border-white/15 bg-white/5 text-sm hover:bg-white/10\" download=\"booking.ics\" href={icsHref(form)}>ICS</a>
          </div>
        </div>
      )
    }

    function expandRecurring(b){ const list=[]; const base=new Date(b.date+'T'+b.start); for(let i=0;i<(b.count||1);i++){ const d=new Date(base); if(b.repeat==='daily') d.setDate(d.getDate()+i); else if(b.repeat==='weekly') d.setDate(d.getDate()+7*i); list.push({...b, date:toISODate(d)}) } return list }

    function StatusPill({status}){
      const map = { scheduled:'bg-white/10 text-white/90', awaiting:'bg-amber-400/20 text-amber-200', 'checked-in':'bg-emerald-400/20 text-emerald-200', 'no-show':'bg-rose-400/20 text-rose-200' }
      return <span className={`text-[11px] px-2 py-1 rounded-full ${map[status]||'bg-white/10'}`}>{status||'—'}</span>
    }

    function BookingList({rooms, items, onDelete, isAdmin, onEdit, onCheckIn, canCheckIn}){
      if (!items.length) return <p className="text-sm text-white/60">Пока нет броней.</p>
      const byDate = [...items].sort((a,b)=> (a.date+a.start).localeCompare(b.date+b.start))
      const roomName = (id)=> rooms.find(r=>r.id===id)?.name||'—'
      const me = tg?.initDataUnsafe?.user?.username
      const canDel = (b)=> isAdmin || (me && b.who===me)
      return (
        <ul className="divide-y divide-white/10">
          {byDate.map(b=> (
            <li key={b.id} className="py-3 flex items-center justify-between gap-3">
              <div>
                <div className="font-medium cursor-pointer" onClick={()=>onEdit?.(b)}>{b.title}</div>
                <div className="text-xs text-white/60">{roomName(b.roomId)} · {fmtDate(b.date)} · {b.start}–{b.end}</div>
              </div>
              <div className="flex gap-2 items-center">
                <StatusPill status={b.status} />
                {canCheckIn?.(b) && <button className="px-3 py-1.5 rounded-xl border border-white/15 bg-white/5 text-sm" onClick={()=>onCheckIn?.(b.id)}>Чек‑ин</button>}
                <span className="text-xs text-white/40">{b.who||'—'}</span>
                <a className="px-3 py-2 rounded-xl border border-white/15 bg-white/5 text-sm" download={`booking-${b.id}.ics`} href={icsHref(b)}>ICS</a>
                {canDel(b) && <button className="px-3 py-2 rounded-xl border border-white/15 bg-white/5 text-sm" onClick={()=>onDelete(b.id)}>Удалить</button>}
              </div>
            </li>
          ))}
        </ul>
      )
    }

    function CalendarView({rooms, bookings, settings, onEdit, onDragSave}){
      const [date, setDate] = React.useState(toISODate(new Date()))
      const dayStart = hm2m(settings.workStart||'08:00'), dayEnd = hm2m(settings.workEnd||'20:00')
      const step = settings.step || 30
      const totalMin = Math.max(step, dayEnd-dayStart)
      const slots = []; for(let h=Math.floor(dayStart/60); h<=Math.floor(dayEnd/60); h++){ slots.push(`${String(h).padStart(2,'0')}:00`) }
      const pxPerHour = 42; const gridH = pxPerHour*slots.length

      const [drag,setDrag] = React.useState(null)

      function startDrag(e, b){
        const duration = hm2m(b.end)-hm2m(b.start)
        const rect = e.currentTarget.parentElement.getBoundingClientRect()
        const y = e.clientY - rect.top
        setDrag({ id:b.id, roomId:b.roomId, duration, offset: y - ((hm2m(b.start)-dayStart)/totalMin)*gridH })
        document.addEventListener('mousemove', onMove)
        document.addEventListener('mouseup', onUp)
      }
      function onMove(e){ setDrag(d=> d? {...d, y:e.clientY}: null) }
      function onUp(){ if(!drag){ cleanup(); return }
        const rect = document.querySelector('[data-calendar-grid]')?.getBoundingClientRect(); if(!rect){ cleanup(); return }
        const y = clamp(drag.y - rect.top - drag.offset, 0, gridH - 10)
        const ratio = y / gridH
        const startMinRaw = dayStart + Math.round((ratio * totalMin) / step) * step
        const endMin = Math.min(dayEnd, startMinRaw + drag.duration)
        const startMin = Math.max(dayStart, endMin - drag.duration)
        onDragSave?.({ id:drag.id, start:m2hm(startMin), end:m2hm(endMin) })
        cleanup()
      }
      function cleanup(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); setDrag(null) }

      const statusColor = (s)=> s==='checked-in' ? 'bg-emerald-400/20 border-emerald-300/40' : s==='awaiting' ? 'bg-amber-400/15 border-amber-300/40' : s==='no-show' ? 'bg-rose-400/15 border-rose-300/40' : 'bg-indigo-400/15 border-indigo-300/40'

      return (
        <div className="grid gap-3">
          <div className="flex items-center gap-2">
            <input type="date" className="border border-white/15 bg-white/5 rounded-xl px-3 py-2" value={date} onChange={(e)=>setDate(e.target.value)} />
            <span className="text-xs text-white/60">Показываем {rooms.length} переговорных</span>
          </div>

          {rooms.map(room=>{
            const list = bookings.filter(b=> b.roomId===room.id && b.date===date)
            return (
            <div key={room.id} className="border border-white/10 rounded-2xl overflow-hidden">
              <div className="px-3 py-2 bg-white/5 text-sm font-medium">{room.name} · {room.capacity} мест</div>
              <div className="relative">
                <div className="grid" style={{gridTemplateColumns:`80px 1fr`}}>
                  <div className="bg-black/60">
                    {slots.map((t,i)=> (<div key={i} className="h-[42px] text-[11px] text-right pr-2 leading-[42px] text-white/40 border-b border-white/10">{t}</div>))}
                  </div>
                  <div className="relative bg-black/40 noselect" style={{height:gridH}} data-calendar-grid>
                    {slots.map((_,i)=> <div key={i} className="h-[42px] border-b border-white/10" />)}
                    {list.map(b=>{
                      const top = ((hm2m(b.start)-dayStart)/totalMin)*gridH
                      const h = ((hm2m(b.end)-hm2m(b.start))/totalMin)*gridH
                      return (
                        <div key={b.id} className={`absolute left-2 right-2 ${statusColor(b.status)} border rounded-lg p-2 text-[12px] cursor-grab active:cursor-grabbing`}
                             style={{top:top, height:Math.max(28,h)}} onMouseDown={(e)=>startDrag(e,b)} onDoubleClick={()=>onEdit?.(b)}>
                          <div className="font-medium truncate">{b.title}</div>
                          <div className="text-[11px] text-white/70">{b.start}–{b.end} · {b.who||'—'} · {b.status||'—'}</div>
                        </div>
                      )
                    })}
                  </div>
                </div>
              </div>
            </div>)
          })}
        </div>
      )
    }

    function AdminPanel({onClose, pins, rooms, settings, onPins, onRooms, onSettings, onImport}){
      const [apins, setApins] = React.useState(pins)
      const [list, setList] = React.useState(rooms)
      const [cfg, setCfg] = React.useState(settings)
      function addRoom(){ setList(l=>[...l,{id:uid(), name:'Новая переговорная', capacity:4, equipment:[] }]) }
      function save(){ onPins(apins); onRooms(list); onSettings(cfg); onClose(); toast('Настройки сохранены') }
      function exportJson(){ const data = JSON.stringify({pins:apins, rooms:list, settings:cfg}, null, 2); const url = 'data:application/json;charset=utf-8,'+encodeURIComponent(data); const a=document.createElement('a'); a.href=url; a.download='roomie-export.json'; a.click() }
      function onFile(e){ const f=e.target.files?.[0]; if(!f) return; const rdr=new FileReader(); rdr.onload=()=>{ try{ const j=JSON.parse(rdr.result); onImport?.(j); toast('Импортировано'); onClose() }catch{ toast('Не удалось импортировать') } }; rdr.readAsText(f) }
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 p-4">
          <div className="w-full max-w-3xl bg-white/10 border border-white/15 backdrop-blur rounded-2xl p-5 shadow-xl grid gap-4">
            <div className="flex justify-between items-center">
              <h3 className="text-lg font-semibold">Админ‑панель</h3>
              <button onClick={onClose} className="text-sm text-white/80">Закрыть</button>
            </div>
            <div className="grid md:grid-cols-2 gap-4">
              <section>
                <h4 className="font-medium mb-2">PIN‑коды</h4>
                <Input label="Админ" value={apins.admin} onChange={(v)=>setApins(p=>({...p, admin:v}))} />
                <Input label="Пользователь" value={apins.user} onChange={(v)=>setApins(p=>({...p, user:v}))} />

                <h4 className="font-medium mt-4 mb-2">Настройки</h4>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                  <Input type="time" label="Начало дня" value={cfg.workStart} onChange={(v)=>setCfg(c=>({...c, workStart:v}))} />
                  <Input type="time" label="Конец дня" value={cfg.workEnd} onChange={(v)=>setCfg(c=>({...c, workEnd:v}))} />
                  <Select label="Шаг" value={cfg.step} onChange={(v)=>setCfg(c=>({...c, step:Number(v)}))}>
                    <option value={15}>15 мин</option>
                    <option value={30}>30 мин</option>
                    <option value={60}>60 мин</option>
                  </Select>
                  <Input type="number" label="Буфер ДО (мин)" value={cfg.bufferBefore} onChange={(v)=>setCfg(c=>({...c, bufferBefore:Number(v||0)}))} />
                  <Input type="number" label="Буфер ПОСЛЕ (мин)" value={cfg.bufferAfter} onChange={(v)=>setCfg(c=>({...c, bufferAfter:Number(v||0)}))} />
                  <div className="col-span-2 md:col-span-1 flex items-center gap-2 mt-2">
                    <input id="rc" type="checkbox" className="h-4 w-4" checked={!!cfg.requireCheckin} onChange={(e)=>setCfg(c=>({...c, requireCheckin:e.target.checked}))} />
                    <label htmlFor="rc" className="text-sm">Требовать чек‑ин</label>
                  </div>
                  <Input type="number" label="Окно чек‑ина (мин)" value={cfg.checkinWindow} onChange={(v)=>setCfg(c=>({...c, checkinWindow:Number(v||15)}))} />
                </div>

                <div className="mt-4 flex gap-2">
                  <Button onClick={exportJson}>Экспорт</Button>
                  <label className="inline-flex items-center px-3 py-2 rounded-xl border border-white/15 bg-white/5 text-sm hover:bg-white/10 cursor-pointer">Импорт JSON
                    <input type="file" accept="application/json" className="hidden" onChange={onFile} />
                  </label>
                </div>
              </section>
              <section>
                <h4 className="font-medium mb-2">Переговорные</h4>
                <div className="grid gap-2">
                  {list.map(r=> (
                    <div key={r.id} className="border border-white/15 rounded-xl p-3 grid grid-cols-5 gap-2 items-center">
                      <input className="col-span-3 border border-white/15 bg-white/5 rounded-xl px-3 py-2" value={r.name} onChange={e=>setList(a=> a.map(x=> x.id===r.id? {...x, name:e.target.value}: x))} />
                      <input type="number" className="border border-white/15 bg-white/5 rounded-xl px-3 py-2" value={r.capacity} onChange={e=>setList(a=> a.map(x=> x.id===r.id? {...x, capacity:Number(e.target.value)}: x))} />
                      <button className="text-sm" onClick={()=> setList(a=> a.filter(x=> x.id!==r.id))}>Удалить</button>
                    </div>
                  ))}
                  <Button onClick={addRoom}>Добавить переговорную</Button>
                </div>
              </section>
            </div>
            <div className="flex justify-end gap-2">
              <button className="px-3 py-2 text-white/80" onClick={onClose}>Отмена</button>
              <Button onClick={save}>Сохранить</Button>
            </div>
          </div>
        </div>
      )
    }

    function EditDialog({booking, rooms, step=30, onClose, onSave, onDelete}){
      const [f,setF] = React.useState({...booking})
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 p-4">
          <div className="w-full max-w-md bg-white/10 border border-white/15 backdrop-blur rounded-2xl p-5 shadow-xl grid gap-3">
            <h3 className="text-lg font-semibold">Редактирование</h3>
            <Select value={f.roomId} onChange={(v)=>setF(o=>({...o, roomId:v}))}>
              {rooms.map(r=> <option key={r.id} value={r.id}>{r.name}</option>)}
            </Select>
            <Input label="Название" value={f.title} onChange={(v)=>setF(o=>({...o, title:v}))} />
            <Input type="date" label="Дата" value={f.date} onChange={(v)=>setF(o=>({...o, date:v}))} />
            <div className="grid grid-cols-2 gap-2">
              <Input type="time" step={step*60} label="Начало" value={f.start} onChange={(v)=>setF(o=>({...o, start:v}))} />
              <Input type="time" step={step*60} label="Окончание" value={f.end} onChange={(v)=>setF(o=>({...o, end:v}))} />
            </div>
            <div className="flex justify-between gap-2">
              <button className="px-3 py-2 text-white/80" onClick={onClose}>Отмена</button>
              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl border border-white/15 bg-white/5" onClick={onDelete}>Удалить</button>
                <Button onClick={()=>onSave(f)}>Сохранить</Button>
              </div>
            </div>
          </div>
        </div>
      )
    }

    function Input({label, value, onChange, type='text', ...rest}){
      return (
        <label className="grid gap-1">
          {label && <span className="text-xs text-white/60">{label}</span>}
          <input {...rest} type={type} value={value}
            onChange={(e)=>onChange?.(e.target.value)}
            className="w-full border border-white/15 bg-white/5 rounded-xl px-3 py-2" />
        </label>
      )
    }
    function Select({label, value, onChange, children, ...rest}){
      return (
        <label className="grid gap-1">
          {label && <span className="text-xs text-white/60">{label}</span>}
          <select {...rest} value={value} onChange={(e)=>onChange?.(e.target.value)} className="w-full border border-white/15 bg-white/5 rounded-xl px-3 py-2">{children}</select>
        </label>
      )
    }

    function fmtDate(d){ const dd=new Date(d+'T00:00:00'); return dd.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'}) }
    function csvHref(list){ if(!list?.length) return 'data:text/plain;charset=utf-8,'+encodeURIComponent(''); const header=['title','room','date','start','end']; const rows=list.map(b=>[b.title,b.roomId,b.date,b.start,b.end]); const all=[header,...rows].map(r=> r.map(v=>'"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n'); return 'data:text/csv;charset=utf-8,'+encodeURIComponent(all) }
    function icsHref(b){ const dt=(d,t)=> d.replaceAll('-','')+'T'+t.replace(':','')+'00'; const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Roomie RU//EN','CALSCALE:GREGORIAN','BEGIN:VEVENT','UID:'+uid()+'@roomie','DTSTAMP:'+dt(toISODate(new Date()), new Date().toTimeString().slice(0,5)),'DTSTART:'+dt(b.date,b.start),'DTEND:'+dt(b.date,b.end),'SUMMARY:'+b.title,'DESCRIPTION:Переговорная','END:VEVENT','END:VCALENDAR'].join('\r\n'); return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics) }

    // ——— tiny toast
    const ToastCtx = React.createContext(null)
    function ToastBar(){ const [msg,set]=React.useState(''); React.useEffect(()=>{ window.__toast=(m)=>{ set(m); clearTimeout(window.__tt); window.__tt=setTimeout(()=>set(''),2500) } },[]); if(!msg) return null; return <div className="fixed bottom-4 left-0 right-0 grid place-items-center z-50"><div className="px-3 py-2 rounded-xl bg-white text-black shadow">{msg}</div></div> }
    function toast(m){ if (tg?.showPopup) tg.showPopup({title:'Roomie+', message:m, buttons:[{type:'ok'}]}); else window.__toast?.(m) }

    const root = ReactDOM.createRoot(document.getElementById('root'))
    root.render(<App />)
  </script>
</body>
</html>
