<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roomie+ ‚Äî –ü—Ä–∞–π–º –°–∞–º–æ–ª—ë—Ç –ü–ª—é—Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--card:rgba(255,255,255,.04);--border:rgba(255,255,255,.10)}
    html,body,#app{height:100%}
    .noselect{-webkit-user-select:none;user-select:none}
    .btn{padding:.6rem .9rem;border-radius:.9rem;background:#fff;color:#111;font-weight:600}
    .btnGhost{padding:.6rem .9rem;border-radius:.9rem;background:var(--card);border:1px solid var(--border)}
    .fld{background:var(--card);border:1px solid var(--border);border-radius:.9rem;padding:.6rem .8rem}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:.75rem}
    @media (max-width:900px){.row{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body class="bg-[#0f0f10] text-white">
<div id="app" class="min-h-full">
  <main id="root" class="max-w-6xl mx-auto p-4 sm:p-6 grid gap-4"></main>
</div>
<script>
// ==== helpers
const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null; try{tg&&tg.ready();tg&&tg.expand()}catch(_){ }
const uid =()=>Math.random().toString(36).slice(2,10);
const hm2m=(hm)=>{const [h,m]=String(hm||'00:00').split(':').map(Number);return (h||0)*60+(m||0)}
const m2hm=(m)=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`
const toISO=(d)=>new Date(d).toISOString().slice(0,10)
const parseISO=(s)=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, (m||1)-1, d||1)}
const fmtDate=(d)=> new Date(d+'T00:00:00').toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'})
const todayISO=()=>toISO(new Date())
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v))
const LS='roomie_v3_dark'

const defaultRooms=[
  {id:'r1', name:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è ‚Ññ1', capacity:6},
  {id:'r2', name:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è ‚Ññ2', capacity:10},
  {id:'r3', name:'Zoom-–∫–∞–ø—Å—É–ª–∞', capacity:2},
]
const defaultState={
  role:'user', pins:{admin:'0404', user:'0000'},
  rooms:defaultRooms,
  bookings:[], // {id, title, who, createdBy, roomId, date, start, end, status}
  settings:{workStart:'09:00',workEnd:'20:00',step:30,bufferBefore:0,bufferAfter:0,checkinWindow:15,requireCheckin:false}
}

function load(){try{return JSON.parse(localStorage.getItem(LS))||structuredClone(defaultState)}catch(_){return structuredClone(defaultState)}}
function save(s){localStorage.setItem(LS, JSON.stringify(s))}
function toast(msg){ if(tg&&tg.showPopup){tg.showPopup({title:'Roomie+',message:String(msg),buttons:[{type:'ok'}]});return;} alert(msg); }

let state=load();
const root=document.getElementById('root');

function setState(p){state=p(state); save(state); render();}
function isAdmin(){return state.role==='admin'}
function currentUserId(){ return tg?.initDataUnsafe?.user?.id ?? null; }
function currentUserName(){
  const u=tg?.initDataUnsafe?.user;
  return u ? [u.first_name,u.last_name].filter(Boolean).join(' ') : (state.__who || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
}

// ==== booking ops
function conflicts(a,b){ if(a.roomId!==b.roomId||a.date!==b.date) return false; const bufB=+state.settings.bufferBefore||0,bufA=+state.settings.bufferAfter||0; const as=hm2m(a.start)-bufB, ae=hm2m(a.end)+bufA, bs=hm2m(b.start)-bufB, be=hm2m(b.end)+bufA; return as<be && bs<ae }
function canDelete(b){
  if(isAdmin()) return true;
  const uidNow=currentUserId();
  if (uidNow && b.createdBy) return uidNow===b.createdBy;
  return (b.who||'').trim()===(currentUserName()||'').trim();
}
function addBooking(b){
  const hit=state.bookings.find(x=>conflicts(x,b)); if(hit){toast(`–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å ¬´${hit.title}¬ª ${hit.start}‚Äì${hit.end}`);return}
  const createdBy=currentUserId();
  setState(s=>({...s, bookings:[...s.bookings, {...b, id:uid(), status:'scheduled', createdBy}]}));
}
function removeBooking(id){ setState(s=>({...s, bookings:s.bookings.filter(b=>b.id!==id)})) }
function updateBooking(patch){
  if(patch.start||patch.end||patch.roomId||patch.date){
    const curr=state.bookings.find(b=>b.id===patch.id); if(!curr) return; const next={...curr,...patch};
    const hit=state.bookings.filter(b=>b.id!==patch.id).find(x=>conflicts(x,next)); if(hit){toast(`–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å ¬´${hit.title}¬ª ${hit.start}‚Äì${hit.end}`);return}
  }
  setState(s=>({...s, bookings:s.bookings.map(b=>b.id===patch.id?{...b,...patch}:b)}))
}

// ==== UI bits
function badge(txt){return `<span class="px-2 py-0.5 rounded-md text-[11px] bg-white/10">${txt}</span>`}
function pickDuration(cb){
  const dlg=document.createElement('div'); dlg.className='fixed inset-0 z-50 grid place-items-center bg-black/70 p-4';
  dlg.innerHTML=`<div class="bg-[var(--card)] border border-[var(--border)] w-full max-w-sm rounded-2xl p-4">
    <h3 class="font-semibold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
    <div class="grid grid-cols-4 gap-2">
      ${[30,60,90,120,150,180].map(m=>`<button class="btnGhost" data-m="${m}">${m===90?'1,5 —á–∞—Å–∞':m%60?m+' –º–∏–Ω':(m/60)+' —á–∞—Å'+(m===60?'':'–∞')}</button>`).join('')}
    </div>
    <div class="text-right mt-4"><button id="close" class="text-sm text-white/70">–û—Ç–º–µ–Ω–∞</button></div>
  </div>`; document.body.appendChild(dlg);
  dlg.querySelectorAll('[data-m]').forEach(b=> b.addEventListener('click', ()=>{ cb(+b.dataset.m); dlg.remove(); }));
  dlg.querySelector('#close').addEventListener('click', ()=>dlg.remove());
}

function render(){
  root.innerHTML='';
  const wrap=document.createElement('div'); wrap.className='grid gap-4';

  // Header
  const top=document.createElement('header');
  top.className='flex items-center justify-between gap-3';
  top.innerHTML=`
    <div class="flex items-center gap-3">
      <img src="logo.png" alt="" class="h-9 w-9 rounded" onerror="this.style.display='none'"/>
      <div class="text-xl font-extrabold tracking-tight">–ø—Ä–∞–π–º —Å–∞–º–æ–ª—ë—Ç ${badge('–ø–ª—é—Å')}</div>
    </div>
    <div class="flex items-center gap-2 text-sm">
      <span class="hidden sm:inline">Telegram WebApp: <span class="text-emerald-400">ok</span></span>
      <span>–†–æ–ª—å: ${isAdmin()?'–ê–¥–º–∏–Ω':'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
      ${isAdmin()?`<button class="btnGhost" id="openAdmin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>`:''}
      <button class="btn" id="auth">${isAdmin()?'–í—ã–π—Ç–∏ –ø–æ PIN':'–í–æ–π—Ç–∏ –ø–æ PIN'}</button>
    </div>`;
  wrap.appendChild(top);
  top.querySelector('#auth').addEventListener('click', openAuth);
  top.querySelector('#openAdmin')?.addEventListener('click', openAdmin);

  // Booking form
  const row=document.createElement('section');
  row.className='grid gap-3 p-4 rounded-2xl border border-[var(--border)] bg-[var(--card)]';

  const step=Number(state.settings.step||30);
  const form={
    date: state.__date || todayISO(),
    start: state.__start || '10:00',
    end:   state.__end || '11:00',
    who:   state.__who || currentUserName(),
    title: state.__title || '–°–∏–Ω–∫ –ø–æ –ø—Ä–æ–µ–∫—Ç—É',
    count: 1, repeat:'none'
  }
  if(!state.__room) state.__room = state.rooms[0]?.id;

  function setEndByDuration(min){ const endMin = hm2m(form.start)+min; form.end=m2hm(endMin); row.querySelector('#end').value=form.end }

  row.innerHTML=`
    <div class="row">
      <label class="grid gap-1"><span class="text-xs text-white/60">–î–∞—Ç–∞</span><input id="date" type="date" class="fld" value="${form.date}"></label>
      <label class="grid gap-1">
        <span class="text-xs text-white/60">–ù–∞—á–∞–ª–æ</span>
        <div class="flex gap-2">
          <input id="start" type="time" step="${step*60}" class="fld flex-1" value="${form.start}">
          <button id="dur" type="button" class="btnGhost" title="–í—ã–±—Ä–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å">‚è±</button>
        </div>
      </label>
      <label class="grid gap-1"><span class="text-xs text-white/60">–û–∫–æ–Ω—á–∞–Ω–∏–µ</span><input id="end" type="time" step="${step*60}" class="fld" value="${form.end}"></label>
      <label class="grid gap-1"><span class="text-xs text-white/60">–§–ò–û –±—Ä–æ–Ω–∏—Ä—É—é—â–µ–≥–æ</span><input id="who" class="fld" value="${form.who}"></label>
      <label class="grid gap-1 col-span-2"><span class="text-xs text-white/60">–ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏</span><input id="title" class="fld" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∏–Ω–∫ –ø–æ –ø—Ä–æ–µ–∫—Ç—É" value="${form.title}"></label>
      <label class="grid gap-1"><span class="text-xs text-white/60">–ü–æ–≤—Ç–æ—Ä</span><select id="repeat" class="fld"><option value="none">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–∞</option><option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option><option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option></select></label>
      <label class="grid gap-1"><span class="text-xs text-white/60">–ö–æ–ª-–≤–æ</span><input id="count" type="number" min="1" value="1" class="fld"></label>
    </div>
    <div class="flex items-center justify-between gap-3 mt-2">
      <div class="text-sm text-white/70">–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è: <span class="font-medium" id="pickedRoomName"></span></div>
      <button class="btn" id="create">–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å</button>
    </div>`;
  wrap.appendChild(row);

  row.querySelector('#date').addEventListener('change',e=>{form.date=e.target.value; state.__date=form.date});
  row.querySelector('#start').addEventListener('change',e=>{form.start=e.target.value; state.__start=form.start});
  row.querySelector('#end').addEventListener('change',e=>{form.end=e.target.value; state.__end=form.end});
  row.querySelector('#who').addEventListener('input',e=>{form.who=e.target.value; state.__who=form.who});
  row.querySelector('#title').addEventListener('input',e=>{form.title=e.target.value; state.__title=form.title});
  row.querySelector('#repeat').addEventListener('change',e=>{form.repeat=e.target.value});
  row.querySelector('#count').addEventListener('change',e=>{form.count=+e.target.value||1});
  row.querySelector('#dur').addEventListener('click',()=>pickDuration(m=>setEndByDuration(m)));

  // rooms list
  const rlist=document.createElement('section');
  rlist.className='p-4 rounded-2xl border border-[var(--border)] bg-[var(--card)]'
  rlist.innerHTML=`
    <div class="flex items-center justify-between mb-2"><h2 class="font-semibold">–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—ã–µ</h2><span class="text-xs text-white/60">${state.rooms.length} —à—Ç.</span></div>
    <div class="grid gap-2">
      ${state.rooms.map(r=>`<button type="button" data-rid="${r.id}" class="w-full text-left p-3 rounded-xl border ${state.__room===r.id?'border-white/40 bg-white/10':'border-[var(--border)] bg-black/20'} hover:bg-white/10 transition">
        <div class="flex items-center justify-between">
          <div><div class="font-medium">${r.name}</div><div class="text-xs text-white/60">${r.capacity} –º–µ—Å—Ç</div></div>
          <div class="text-xs text-white/60">ID: ${r.id}</div>
        </div>
      </button>`).join('')}
    </div>`;
  wrap.appendChild(rlist);

  function setPicked(){ const rn = state.rooms.find(x=>x.id===state.__room)?.name || '‚Äî'; row.querySelector('#pickedRoomName').textContent = rn }
  setPicked();
  rlist.querySelectorAll('[data-rid]').forEach(b=> b.addEventListener('click',()=>{ state.__room=b.getAttribute('data-rid'); render(); }));

  // create booking
  row.querySelector('#create').addEventListener('click',()=>{
    const roomId = state.__room; if(!roomId){toast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—É—é');return}
    if(hm2m(form.end)<=hm2m(form.start)){ toast('–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞'); return }
    const who = form.who?.trim() || '‚Äî';
    const base={ title: form.title?.trim()||'–í—Å—Ç—Ä–µ—á–∞', who, roomId, date: form.date, start: form.start, end: form.end };
    const list=[]; const cnt=+form.count||1; const baseDate=parseISO(base.date);
    for(let i=0;i<cnt;i++){ const d=new Date(baseDate); if(form.repeat==='daily') d.setDate(d.getDate()+i); else if(form.repeat==='weekly') d.setDate(d.getDate()+7*i); list.push({...base, date:toISO(d)}); }
    for(const x of list){ const hit=state.bookings.find(b=>conflicts(b,x)); if(hit){toast(`–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å ¬´${hit.title}¬ª ${hit.start}‚Äì${hit.end}`); return} }
    list.forEach(addBooking);
    toast('–ë—Ä–æ–Ω—å —Å–æ–∑–¥–∞–Ω–∞');
  });

  // === –ú–æ–∏ –±—Ä–æ–Ω–∏
  const mine=document.createElement('section');
  mine.className='p-4 rounded-2xl border border-[var(--border)] bg-[var(--card)] grid gap-3';
  const uidNow=currentUserId(), uname=currentUserName();
  const mineList = (isAdmin()
    ? [...state.bookings]
    : state.bookings.filter(b=> (uidNow && b.createdBy && b.createdBy===uidNow) || (!b.createdBy && (b.who||'').trim()===uname.trim()))
  ).sort((a,b)=> (a.date+a.start).localeCompare(b.date+b.start));

  mine.innerHTML = `
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">–ú–æ–∏ –±—Ä–æ–Ω–∏</h2>
      <input id="search" class="fld w-60" placeholder="–ü–æ–∏—Å–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∫–æ–º–Ω–∞—Ç–∞">
    </div>
    ${mineList.length
      ? `<ul id="mineList" class="divide-y" style="border-color:var(--border)"></ul>`
      : `<p class="text-sm text-white/60">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤–∞–º–∏ –±—Ä–æ–Ω–µ–π.</p>`
    }`;
  wrap.appendChild(mine);

  const roomName=(id)=> state.rooms.find(r=>r.id===id)?.name || '‚Äî';

  if(mineList.length){
    const ul=mine.querySelector('#mineList');
    const renderMine=(q='')=>{
      ul.innerHTML = mineList
        .filter(b=>{
          if(!q) return true;
          q=q.toLowerCase();
          return (b.title||'').toLowerCase().includes(q) || roomName(b.roomId).toLowerCase().includes(q);
        })
        .map(b=>`
          <li class="py-3 flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium truncate">${b.title}</div>
              <div class="text-xs text-white/60">${fmtDate(b.date)} ¬∑ ${b.start}‚Äì${b.end} ¬∑ ${roomName(b.roomId)} ¬∑ ${b.who||'‚Äî'}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btnGhost text-sm" data-edit="${b.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              ${canDelete(b)?`<button class="btnGhost text-sm" data-del="${b.id}">–£–¥–∞–ª–∏—Ç—å</button>`:''}
            </div>
          </li>
        `).join('');
      ul.querySelectorAll('[data-edit]').forEach(x=> x.addEventListener('click',()=>openEdit(x.getAttribute('data-edit'))));
      ul.querySelectorAll('[data-del]').forEach(x=> x.addEventListener('click',()=>removeBooking(x.getAttribute('data-del'))));
    };
    renderMine();
    mine.querySelector('#search').addEventListener('input', e=>renderMine(e.target.value));
  }

  // calendar
  const calWrap=document.createElement('section');
  calWrap.className='p-4 rounded-2xl border border-[var(--border)] bg-[var(--card)] grid gap-3';
  calWrap.innerHTML=`<div class="flex items-center justify-between"><h2 class="font-semibold">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–Ω—è</h2><span class="text-xs text-white/60">–†–æ–ª—å: ${isAdmin()?'–ê–¥–º–∏–Ω':'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span></div><div id="cal"></div>`;
  wrap.appendChild(calWrap);

  root.appendChild(wrap);
  renderCalendar();
}

function renderCalendar(){
  const $cal=document.getElementById('cal');
  const day = state.__calDate || state.__date || todayISO();
  $cal.innerHTML='';

  const nav=document.createElement('div');
  nav.className='flex items-center gap-2 mb-3 relative z-10';
  nav.innerHTML=`<button type="button" class="btnGhost" id="prevD">‚Üê</button>
                 <input class="fld" id="calDate" type="date" value="${day}" style="min-height:42px"/>
                 <button type="button" class="btnGhost" id="nextD">‚Üí</button>`;
  $cal.appendChild(nav);

  nav.querySelector('#prevD').addEventListener('click', ()=>{const d=parseISO(day); d.setDate(d.getDate()-1); state.__calDate=toISO(d); renderCalendar(); });
  nav.querySelector('#nextD').addEventListener('click', ()=>{const d=parseISO(day); d.setDate(d.getDate()+1); state.__calDate=toISO(d); renderCalendar(); });
  nav.querySelector('#calDate').addEventListener('change', (e)=>{ state.__calDate=e.target.value; renderCalendar(); });

  const dayStart=hm2m(state.settings.workStart), dayEnd=hm2m(state.settings.workEnd), step=+state.settings.step||30;
  const slots=[]; for(let m=dayStart;m<=dayEnd;m+=60) slots.push(m2hm(m));
  const pxH=42, gridH=pxH*slots.length;

  const shell=document.createElement('div'); shell.className='grid'; shell.style.gridTemplateColumns='90px 1fr'; $cal.appendChild(shell);
  const times=document.createElement('div'); times.innerHTML=slots.map(t=>`<div class="h-[42px] text-right pr-2 text-xs text-gray-500 border-b" style="border-color:var(--border)">${t}</div>`).join(''); shell.appendChild(times);
  const area=document.createElement('div'); area.className='relative noselect z-0'; area.style.height=gridH+'px'; area.style.background='rgba(255,255,255,.03)'; area.style.marginTop='2px'; shell.appendChild(area);
  slots.forEach(()=>{ const r=document.createElement('div'); r.className='h-[42px] border-b'; r.style.borderColor='var(--border)'; area.appendChild(r); });

  // draw blocks
  state.rooms.forEach(room=>{
    state.bookings.filter(b=>b.roomId===room.id && b.date===day).forEach(b=>{
      const top=((hm2m(b.start)-dayStart)/(dayEnd-dayStart))*gridH;
      const h=((hm2m(b.end)-hm2m(b.start))/(dayEnd-dayStart))*gridH;
      const el=document.createElement('div');
      const color=b.status==='checked-in'?'border-emerald-300/40 bg-emerald-400/15': b.status==='awaiting'?'border-amber-300/40 bg-amber-400/15': b.status==='no-show'?'border-rose-300/40 bg-rose-400/15':'border-indigo-300/40 bg-indigo-400/15';
      el.className=`absolute left-24 right-3 ${color} border rounded-lg p-2 text-[12px] cursor-grab active:cursor-grabbing`;
      el.style.top=top+'px'; el.style.height=Math.max(28,h)+'px';
      el.innerHTML=`<div class='font-medium truncate'>${b.title}</div>
        <div class='text-[11px] opacity-80'>${b.start}‚Äì${b.end} ¬∑ ${room.name} ¬∑ ${b.who||'‚Äî'}</div>
        ${canDelete(b)?`<button title="–£–¥–∞–ª–∏—Ç—å" data-del="${b.id}" class="absolute top-1.5 right-1.5 text-[11px] px-2 py-0.5 rounded bg-white/20 hover:bg-white/30">üóë</button>`:''}`;
      el.addEventListener('dblclick', ()=>openEdit(b.id));
      area.appendChild(el);

      el.querySelector('[data-del]')?.addEventListener('click', (e)=>{ e.stopPropagation(); removeBooking(b.id); });

      // D&D move vertically
      let drag=null; el.addEventListener('mousedown', (ev)=>{
        const rect=area.getBoundingClientRect(); const dur=hm2m(b.end)-hm2m(b.start); const off=ev.clientY-(rect.top+((hm2m(b.start)-dayStart)/(dayEnd-dayStart))*gridH); drag={id:b.id,dur,off};
        document.onmousemove=e=>{if(!drag)return; drag.y=e.clientY};
        document.onmouseup=()=>{ if(!drag){cleanup();return} const r2=area.getBoundingClientRect(); let y=clamp(drag.y-r2.top-drag.off,0,gridH-10); const ratio=y/gridH; const startRaw=dayStart+Math.round((ratio*(dayEnd-dayStart))/step)*step; const endMin=Math.min(dayEnd,startRaw+drag.dur); const startMin=Math.max(dayStart,endMin-drag.dur); updateBooking({id:b.id,start:m2hm(startMin),end:m2hm(endMin)}); cleanup(); };
        function cleanup(){document.onmousemove=null;document.onmouseup=null;drag=null}
      });
    });
  });
}

// ==== Auth & Admin
function openAuth(){
  const dlg=document.createElement('div'); dlg.className='fixed inset-0 z-50 grid place-items-center bg-black/70 p-4';
  dlg.innerHTML=`<div class="w-full max-w-sm bg-[var(--card)] border border-[var(--border)] rounded-2xl p-5">
    <h3 class="text-lg font-semibold mb-3">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ PIN</h3>
    <input id="pin" class="fld w-full mb-3" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN" inputmode="numeric"/>
    <div class="flex justify-end gap-2"><button id="cancel" class="text-sm text-white/70">–û—Ç–º–µ–Ω–∞</button><button id="ok" class="btn">–í–æ–π—Ç–∏</button></div>
  </div>`; document.body.appendChild(dlg);
  dlg.querySelector('#cancel').addEventListener('click', ()=>dlg.remove());
  dlg.querySelector('#ok').addEventListener('click', ()=>{
    const v=dlg.querySelector('#pin').value.trim();
    if(v===state.pins.admin) setState(s=>({...s,role:'admin'}));
    else if(v===state.pins.user) setState(s=>({...s,role:'user'}));
    else toast('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');
    dlg.remove();
  });
}

function openAdmin(){
  const cfg=JSON.parse(JSON.stringify(state.settings)); const rooms=JSON.parse(JSON.stringify(state.rooms));
  const dlg=document.createElement('div'); dlg.className='fixed inset-0 z-50 grid place-items-center bg-black/70 p-4';
  dlg.innerHTML=`<div class="w-full max-w-3xl bg-[var(--card)] border border-[var(--border)] rounded-2xl p-5 grid gap-4">
    <div class="flex items-center justify-between"><h3 class="text-lg font-semibold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3><button id="close" class="text-sm text-white/70">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <div class="grid md:grid-cols-2 gap-4">
      <section>
        <h4 class="font-medium mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</h4>
        <div class="grid grid-cols-3 gap-2">
          <label class="grid gap-1"><span class="text-xs text-white/60">–ù–∞—á–∞–ª–æ</span><input id="ws" type="time" class="fld" value="${cfg.workStart}"></label>
          <label class="grid gap-1"><span class="text-xs text-white/60">–ö–æ–Ω–µ—Ü</span><input id="we" type="time" class="fld" value="${cfg.workEnd}"></label>
          <label class="grid gap-1"><span class="text-xs text-white/60">–®–∞–≥, –º–∏–Ω</span><select id="step" class="fld"><option value="15" ${cfg.step==15?'selected':''}>15</option><option value="30" ${cfg.step==30?'selected':''}>30</option><option value="60" ${cfg.step==60?'selected':''}>60</option></select></label>
        </div>
      </section>
      <section>
        <h4 class="font-medium mb-2">–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—ã–µ</h4>
        <div id="roomList" class="grid gap-2">
          ${rooms.map(r=>`<div class='grid grid-cols-5 gap-2 items-center'><input data-id='${r.id}' data-k='name' class='fld col-span-3' value='${r.name}'/><input data-id='${r.id}' data-k='capacity' type='number' class='fld' value='${r.capacity}'/><button data-del='${r.id}' class='btnGhost'>–£–¥–∞–ª–∏—Ç—å</button></div>`).join('')}
        </div>
        <button id="addRoom" class="btn mt-2">–î–æ–±–∞–≤–∏—Ç—å</button>
      </section>
    </div>
    <div class="text-right"><button id="save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div>`; document.body.appendChild(dlg);

  dlg.querySelector('#addRoom').addEventListener('click', ()=>{ rooms.push({id:uid(),name:'–ù–æ–≤–∞—è',capacity:4}); dlg.remove(); openAdmin(); });
  dlg.querySelectorAll('[data-del]').forEach(x=> x.addEventListener('click',()=>{ const id=x.getAttribute('data-del'); const i=rooms.findIndex(r=>r.id===id); if(i>-1) rooms.splice(i,1); dlg.remove(); openAdmin(); }));
  dlg.querySelectorAll('[data-k]').forEach(x=> x.addEventListener('change',(e)=>{ const id=e.target.getAttribute('data-id'); const k=e.target.getAttribute('data-k'); const r=rooms.find(r=>r.id===id); if(r) r[k]= k==='capacity'? Number(e.target.value): e.target.value; }));

  dlg.querySelector('#close').addEventListener('click', ()=>dlg.remove());
  dlg.querySelector('#save').addEventListener('click', ()=>{ const ns={ workStart:dlg.querySelector('#ws').value, workEnd:dlg.querySelector('#we').value, step:Number(dlg.querySelector('#step').value) }; setState(s=>({...s, rooms, settings:{...s.settings,...ns}})); dlg.remove(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); });
}

function openEdit(id){
  const b=state.bookings.find(x=>x.id===id); if(!b) return;
  const dlg=document.createElement('div'); dlg.className='fixed inset-0 z-50 grid place-items-center bg-black/70 p-4';
  const canDel=canDelete(b);
  dlg.innerHTML=`<div class='w-full max-w-md bg-[var(--card)] border border-[var(--border)] rounded-2xl p-5 grid gap-3'>
    <h3 class='text-lg font-semibold'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
    <label class='grid gap-1'><span class='text-xs text-white/60'>–ù–∞–∑–≤–∞–Ω–∏–µ</span><input id='t' class='fld' value='${b.title}'/></label>
    <label class='grid gap-1'><span class='text-xs text-white/60'>–§–ò–û</span><input id='w' class='fld' value='${b.who||''}'/></label>
    <label class='grid gap-1'><span class='text-xs text-white/60'>–î–∞—Ç–∞</span><input id='d' type='date' class='fld' value='${b.date}'/></label>
    <div class='grid grid-cols-2 gap-2'>
      <label class='grid gap-1'><span class='text-xs text-white/60'>–ù–∞—á–∞–ª–æ</span><input id='s' type='time' class='fld' value='${b.start}'/></label>
      <label class='grid gap-1'><span class='text-xs text-white/60'>–û–∫–æ–Ω—á–∞–Ω–∏–µ</span><input id='e' type='time' class='fld' value='${b.end}'/></label>
    </div>
    <div class='flex justify-between gap-2'>
      ${canDel?`<button id='del' class='btnGhost'>–£–¥–∞–ª–∏—Ç—å</button>`:'<span></span>'}
      <div class='flex gap-2'><button id='ok' class='btn'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id='cancel' class='btnGhost'>–û—Ç–º–µ–Ω–∞</button></div>
    </div>
  </div>`; document.body.appendChild(dlg);
  dlg.querySelector('#cancel').addEventListener('click', ()=>dlg.remove());
  if(canDel) dlg.querySelector('#del').addEventListener('click', ()=>{ removeBooking(id); dlg.remove(); });
  dlg.querySelector('#ok').addEventListener('click', ()=>{
    updateBooking({id, title:dlg.querySelector('#t').value, who:dlg.querySelector('#w').value, date:dlg.querySelector('#d').value, start:dlg.querySelector('#s').value, end:dlg.querySelector('#e').value});
    dlg.remove();
  });
}

render();
</script>
</body>
</html>
